<!--
Page: Admin Dashboard
Purpose:
  - Central hub for clinic metrics and management.
  - Navigation to bookings, analytics, and content management.

Main Features:
  - Manage Bookings
  - View Analytics
  - Manage Website Content
  - Logout
-->

<!--
Page: Admin Dashboard
Purpose:
  - Central hub for clinic metrics and management.
  - Navigation to bookings, analytics, and content management.

Main Features:
  - Manage Bookings
  - View Analytics
  - Manage Website Content
  - Logout
-->
<!--
Page: Admin Dashboard
Purpose:
  - Central hub for clinic metrics and management.
  - Navigation to bookings, analytics, and content management.

Main Features:
  - Manage Bookings
  - View Analytics
  - Manage Website Content
  - Logout
-->


<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Staff Dashboard - Appointments</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


  <style>
    body {
      margin: 0;
        font-family: 'Inter', sans-serif;
        background: #F9F9FD;
        color: #333;
        
    }


    .nav-header {
      display: flex;
      justify-content: space-between; /* spread out left, middle, right */
      align-items: center;
      padding: 20px 40px;
      font-size: 14px;
      width: 100%;
      font-weight: 500;
      border: none;
      padding-top: 15px;
    }

        .logo {
            display: flex;
            align-items: center;
        }

        .logo_image {
            width: auto;
            height: 130px;
            padding-left: 0px;
        }

        .nav {
            display: flex;
            align-items: center;
            margin-left: 680px;

        }

        .contact_us { 
            text-decoration: underline;
            text-underline-offset: 4px;    
            text-decoration-thickness: 1px;  
        }

        .nav a {
            text-decoration: none;
            color: #000;   
            width: 180px;
        }

        .nav a:hover {
            font-weight: 600;   
        }

        .login {
            font-size: 30px;
        }

    .main {
      grid-row: 2 / 3;
      grid-column: 2 / 3;
      display: grid;
      grid-template-rows: 180px 55px 1fr;
      gap: 40px;
      width: 100%;
    }
   

    .log-table {
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: bold;
      font-size: 1rem;
      letter-spacing: 1px;
      height: 100px;
      margin-top: 150px;


    }
    .large-log-table {
      display: flex;
      font-weight: bold;
      font-size: 1.1rem;
      letter-spacing: 1px;
      margin-top: 150px;
    }
    .main > .analytics-row > div {
      font-size: 1rem;
      color: #fff;
      letter-spacing: 1px;
    }


  .shimmer {
    position: relative;
    overflow: hidden;
    background-color: rgba(148, 163, 184, 0.25);
  }
  .shimmer::after {
    content: "";
    position: absolute;
    inset: 0;
    transform: translateX(-100%);
    background-image: linear-gradient(
      90deg,
      rgba(255,255,255,0) 0%,
      rgba(255,255,255,0.7) 50%,
      rgba(255,255,255,0) 100%
    );
    animation: shimmer-move 2s infinite;
  }
  @keyframes shimmer-move {
    100% { transform: translateX(100%); }
  }

  .logout-link {
    display: inline-flex;  /* Treats the link as a flexible container */
    align-items: center; /* Vertically centers the icon and text */
    gap: 0.5rem;         /* Adds a nice space between the icon and text */
    
    /* Optional: Style it to look like a link */
    text-decoration: none;
    color: #dc2626; /* A red color, common for logout/danger */
    font-weight: 500;
}

/* Controls the size of the icon */
.logout-link svg {
    width: 1.25rem;  /* 20px */
    height: 1.25rem; /* 20px */
}

/* Optional: Add a hover effect */
.logout-link:hover {
    text-decoration: underline;
}


  </style>
</head>
<body>
  <header class="nav-header">
    <div class="logo">
        <img class="logo_image" src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo">
    </div>
  
  
    <nav class="nav">
      <a href="{{ url_for('views.home') }}">Home</a>  
      <a href="{{ url_for('views.home') }}" class="logout-link">
        <svg 
            xmlns="http://www.w3.org/2000/svg" 
            viewBox="0 0 20 20" 
            fill="currentColor"
        >
            <path 
                fill-rule="evenodd" 
                d="M3 3.25A2.25 2.25 0 015.25 1h9.5A2.25 2.25 0 0117 3.25V6.75h-1.5V3.25a.75.75 0 00-.75-.75h-9.5a.75.75 0 00-.75.75v13.5a.75.75 0 00.75.75h9.5a.75.75 0 00.75-.75v-3.5H17v3.5A2.25 2.25 0 0114.75 19h-9.5A2.25 2.25 0 013 16.75V3.25z" 
                clip-rule="evenodd" 
            />
            <path 
                fill-rule="evenodd" 
                d="M6.75 9a.75.75 0 000 1.5h6.58l-3.22 3.22a.75.75 0 101.06 1.06l4.5-4.5a.75.75 0 000-1.06l-4.5-4.5a.75.75 0 10-1.06 1.06l3.22 3.22H6.75z" 
                clip-rule="evenodd" 
            />
        </svg>
        <span>Logout</span>
    </a>  
    </nav>
    
  </header>

      <span 
      class="text-gray-700 text-3xl font-semibold" 
      style="position: relative; left: 80px; padding-top: 200px;"
    >
      Revenue and Customer Analytics
    </span>

    <div class="grid grid-rows-[70px,1fr] grid-cols-[60px,1fr] h-screen w-full gap-4">

  

    <div class="main">

      <!-- Top analytics row -->

<!-- Analytics Section Layout Matching Provided Image -->


<div class="grid grid-cols-4 grid-rows-2 gap-6 h-[400px] w-full pr-5 pl-20 pb-12 ">



    <div class="grid grid-cols-2 gap-4">
          <div class="bg-white rounded-2xl border border-gray-200 p-7 py-5">
            
            <h4 class="text-[22px] leading-tight font-semibold text-gray-900">Patients</h4>

            <div class="mt-2">
                <span class="block text-[57px] leading-none font-semibold text-gray-900">12</span>
              </div>
              <div class="mt-2 flex items-center gap-3">
                <span class="flex items-center text-green-500 ml-2">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 6h9v9" />
                  </svg>
                </span>
                <span class="text-[18px] leading-none font-normal text-slate-400">10.2%</span>
              </div>
              
          </div>

          <div class="bg-transparent rounded-2xl p-4">
            


          </div>
    </div>
    

    <!-- Middle tall box -->
        <!-- Bookings by Service card -->
        <div class="bg-white border border-gray-200 rounded-2xl col-span-1 row-span-2 shadow-sm p-6 flex flex-col">
            <!-- Header -->
            <div class="flex items-start justify-between">
            <h3 class="text-[23px] leading-tight font-semibold text-gray-800">Services</h3>
            <button class="text-gray-400 hover:text-gray-500">
                <span class="inline-flex gap-1">
                <span class="w-1.5 h-1.5 bg-gray-400 rounded-full"></span>
                <span class="w-1.5 h-1.5 bg-gray-400 rounded-full"></span>
                <span class="w-1.5 h-1.5 bg-gray-400 rounded-full"></span>
                </span>
            </button>
            </div>
        
            <!-- Chart area -->
            <div class="mt-4 flex-1 flex items-center justify-center" style="margin-top: -40px;">
                <div class="relative w-full max-w-[360px] aspect-square">
                  <div class="absolute -inset-6 blur-2xl rounded-full bg-indigo-200/20 pointer-events-none"></div>
                  <canvas id="bookingsByService" class="relative z-10" height="150"></canvas>
                </div>
              </div>
              
        
            <!-- Optional legend (top N services) -->
            <div id="serviceLegend" class=" mt-0 grid grid-cols-2 gap-y-2 gap-x-6 justify-items-start" style="margin-top: -40px; font-size: small;"></div>
        </div>





    <!-- Large box on right -->


    <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-6 col-span-2 row-span-2 flex flex-col">
        <!-- Title -->
        <div class="flex items-center justify-between">
          <h3 class="text-[23px] mb-3 leading-tight font-semibold text-gray-700">Utilization</h3>
          <span class="text-gray-400">•••</span>
        </div>
      
        <!-- Chart -->
        <div class="mt-3">
          <div class="relative w-full h-[180px] mb-5">
            <canvas id="kpiLine"></canvas>
          </div>
        </div>
      
      
        <!-- Download button -->
        <button class="w-full inline-flex items-center justify-center gap-2 px-5 py-3 rounded-2xl border border-gray-300 text-gray-700 hover:bg-gray-50">
          Download Report
          <svg class="w-5 h-5 text-gray-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M7 10l5 5 5-5M12 15V3" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M20 21H4a2 2 0 01-2-2v0a2 2 0 012-2h16a2 2 0 012 2v0a2 2 0 01-2 2z" />
          </svg>
        </button>
      </div>
      
    
    
    <!-- Bottom left small box -->
    <div class="relative bg-white rounded-2xl shadow p-5 h-full flex flex-col overflow-hidden px-8">
        
        
        <!-- Icon badge (top-right) -->
        <div class="absolute top-6 right-10">
          <div class="relative">
            <!-- glow -->
            <div class="absolute inset-0 blur-l rounded-2xl "></div>
            <!-- tile -->
            <div class="relative w-16 h-16 rounded-2xl bg-white shadow-[0_8px_20px_-10px_rgba(0,0,0,0.15)] flex items-center justify-center">
              <!-- red bag icon -->
              <svg class="w-9 h-9 text-rose-400 " viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 7V6a3 3 0 116 0v1" />
                <rect x="5" y="7.5" width="14" height="11.2" rx="4" stroke="currentColor"/>
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 12h4" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M7.6 15.3c2.1 1.2 6.7 1.2 8.8 0" />
              </svg>
              
            </div>
          </div>
        </div>

        

        <!-- Top content (optional): leave empty or add an icon/summary -->
        <div class="flex-1"></div>
      
        <!-- Revenue value and label -->
        <div>
          <div class="text-[35px] leading-none font-semibold text-gray-900">£23,283</div>
          <div class="mt-3 text-[20px] leading-tight font-light text-gray-900">Total Revenue</div>
        </div>
      
        <!-- Delta line -->
        <div class="mt-6 flex items-center gap-3">
          <span class="flex items-center text-green-500 ml-1">
            <!-- 45° up-right arrow with tail -->
            <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 6h9v9" />
            </svg>
          </span>
          <span class="text-[17px] leading-none font-normal text-slate-400">+0.49% this week</span>
        </div>
      </div>
  </div>
  

      

      <!-- Log table rows -->
      <div class="log-table">


            <div class="flex items-center justify-between w-full h-full px-2">
                <!-- Left: Section title -->
                <span class="text-gray-700 text-3xl font-semibold">Treatment Log</span>
            
                <!-- Middle: Controls (filter, navigation, search, dropdown) -->
                <div class="flex items-center gap-4">
                <button class="px-7 py-2 rounded font-medium" style="background-color: #E7EDFA; color: #334155;">Today</button>

                <button class="w-8 h-8 flex items-center justify-center text-gray-700 hover:bg-white rounded" >
                    &lt;
                </button>
                <button class="w-8 h-8 flex items-center justify-center text-gray-700 hover:bg-white rounded">
                    &gt;
                </button>
                
                <div class="relative">
                    <span class="absolute inset-y-0 left-3 flex items-center text-gray-400">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-4.35-4.35M11 17a6 6 0 100-12 6 6 0 000 12z"/>
                    </svg>
                    </span>
                    <input
                    type="text"
                    placeholder="Search"
                    class="pl-10 pr-20 py-2 rounded-lg bg-white text-gray-600 font-normal border border-grey"
                  />
                  
                </div>


                <div class="relative w-64">
                    <!-- Person icon left -->
                    <span class="absolute inset-y-0 left-3 flex items-center text-gray-400 pointer-events-none">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804
                            M15 10a3 3 0 11-6 0 3 3 0 016 0z" />
                      </svg>
                    </span>
                    <!-- Custom Right Arrow -->
                    <span class="absolute inset-y-0 right-3 flex items-center text-gray-400 pointer-events-none">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
                      </svg>
                    </span>
                    <select class="pl-10 pr-10 py-2 rounded-lg bg-transparent border border-gray-400 text-gray-600 font-normal w-64 text-sm appearance-none">
                      <option>All Practitioners</option>
                      <option>Practitioner 1</option>
                      <option>Practitioner 2</option>
                    </select>
                  </div>
            
                
                <!-- Right: Download button -->
                <button class="px-20 py-2 rounded bg-indigo-500 hover:bg-indigo-700 text-white font-semibold shadow w-[20rem]">Download CSV</button>
            </div>
            



      </div>
      
    </div>
      
      
      <div class="large-log-table">
        <div class="table-wrapper flex-1 bg-gray-300 rounded overflow-x-auto shadow-md sm:rounded-lg">
            <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
              <thead class="text-s text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                <tr>
                  <th scope="col" class="px-6 py-3">Booking ID</th>
                  <th scope="col" class="px-6 py-3">Client Name</th>
                  <th scope="col" class="px-6 py-3">Client Contact</th>
                  <th scope="col" class="px-6 py-3">Client Gender</th>
                  <th scope="col" class="px-6 py-3">Staff Member</th>
                  <th scope="col" class="px-6 py-3">Staff Gender</th>
                  <th scope="col" class="px-6 py-3">Start Time</th>
                  <th scope="col" class="px-6 py-3">End Time</th>
                  <th scope="col" class="px-6 py-3">Status</th>
                  <th scope="col" class="px-6 py-3">Payment(£)</th>
                  <th scope="col" class="px-6 py-3">Notes</th>
                </tr>
              </thead>
              <tbody id="appt-tbody" class="bg-white divide-y divide-gray-200 dark:bg-gray-300 dark:divide-gray-300">
                <!-- data loaded here dynamically -->

                <tr id="appt-skeleton">
                    <td colspan="11" class="px-6 py-8">
                      <div class="space-y-3">
                        <div class="shimmer h-5 rounded w-5/6"></div>
                        <div class="shimmer h-5 rounded w-5/6"></div>
                        <div class="shimmer h-5 rounded w-5/6"></div>
                        <div class="shimmer h-5 rounded w-5/6"></div>
                      </div>
                    </td>
                  </tr>
                                

              </tbody>
            </table>
          </div>
      </div>


    </div>
  </div>


  
 <script>

      // Example payload (replace with your API response)
  const resp = {
    slices: [
      { label: 'Hijama', value: 42 },
      { label: 'Massage', value: 31 },
      { label: 'Consultation', value: 18 },
      { label: 'Products', value: 7 }
    ],
    total: 98
  };

  const labels = resp.slices.map(s => s.label);
  const values = resp.slices.map(s => s.value);

  const canvas = document.getElementById('bookingsByService');
  const ctx = canvas.getContext('2d');

  // Gradients/palette
  const g1 = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
  g1.addColorStop(0, '#141A46'); g1.addColorStop(1, '#3D4E9C'); // deep navy
  const g2 = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
  g2.addColorStop(0, '#EAF0FF'); g2.addColorStop(1, '#E9EFFB'); // pale blue
  const g3 = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
  g3.addColorStop(0, '#B9A9FF'); g3.addColorStop(1, '#8B6CF6'); // purple
  const g4 = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
  g4.addColorStop(0, '#7FF3CF'); g4.addColorStop(1, '#34D399'); // mint

  const bg = [g1, g2, g3, g4]; // extend if needed

  const lineChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{
        data: values,
        backgroundColor: labels.map((_, i) => bg[i % bg.length]),
        borderColor: '#FFFFFF',
        borderWidth: 0,      // as requested
        spacing: 5,          // as requested
        cutout: '50%'        // as requested
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      layout: { padding: { top: 0, right: 60, bottom: 0, left: 60 } }, // side padding
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (ctx) => {
              const total = values.reduce((a,b)=>a+b,0);
              const val = ctx.raw;
              const pct = total ? (val/total*100).toFixed(1) : 0;
              return `${ctx.label}: ${val} (${pct}%)`;
            }
          }
        }
      }
    },
    plugins: [{
      id: 'centerLabel',
      afterDraw(chart) {
        const {ctx, chartArea} = chart;
        const cx = (chartArea.left + chartArea.right) / 2;
        const cy = (chartArea.top + chartArea.bottom) / 2;

        // Faint inner ring
        ctx.save();
        ctx.lineWidth = 5;
        ctx.strokeStyle = 'rgba(0,0,0,0.04)';
        ctx.beginPath();
        ctx.arc(cx, cy, Math.min(chartArea.width, chartArea.height)/4, 0, Math.PI*2);
        ctx.stroke();
        ctx.restore();

        // Center total (bookings count)
        ctx.save();
        ctx.fillStyle = 'black';
        ctx.font = '500 25px Inter, system-ui, sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(resp.total.toString(), cx, cy);
        ctx.restore();
      }
    }]
  });

  // Build a compact legend from the slices
  const legendRoot = document.getElementById('serviceLegend');
  const colors = ['#141A46', '#E9EFFB', '#8B6CF6', '#34D399']; // match bg order
  resp.slices.forEach((s, i) => {
    const item = document.createElement('div');
    item.className = 'flex items-center gap-1';
    item.innerHTML = `
      <span class="inline-block w-2.5 h-2.5 rounded-full" style="background:${colors[i % colors.length]}"></span>
      <span class="text-gray-800 text-sm">${s.label} (${s.value})</span>
    `;
    legendRoot.appendChild(item);
  });
  </script>

<script>
    
  // Dummy dates and values (last 14 days)
  const lineLabels = Array.from({length: 14}, (_, i) => {
    const d = new Date(); d.setDate(d.getDate() - (13 - i));
    return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
  });

  const primary = [22, 48, 66, 40, 92, 78, 55, 47, 63, 82, 96, 88, 71, 84]; // your main series
  const compare = [38, 32, 52, 60, 68, 62, 58, 54, 61, 70, 83, 76, 69, 72];  // faded comparison

  const newCtx = document.getElementById('kpiLine').getContext('2d');

  // Gradient fill for primary
  const grad = newCtx.createLinearGradient(0, 0, 0, 180);
  grad.addColorStop(0, 'rgba(99, 102, 241, 0.25)');  // indigo-500 at top with alpha
  grad.addColorStop(1, 'rgba(99, 102, 241, 0.00)');  // fade to transparent

  const chart = new Chart(newCtx, {
    type: 'line',
    data: {
      labels: lineLabels,
      datasets: [
        {
          label: 'This Period',
          data: primary,
          borderColor: '#4F46E5',      // indigo-600
          backgroundColor: grad,
          fill: true,
          borderWidth: 3,
          tension: 0.42,
          pointRadius: 0
        },
        {
          label: 'Previous Period',
          data: compare,
          borderColor: 'rgba(99, 102, 241, 0.35)',
          backgroundColor: 'rgba(99, 102, 241, 0.10)',
          fill: false,
          borderWidth: 2,
          tension: 0.42,
          pointRadius: 0
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          mode: 'index',
          intersect: false,
          callbacks: {
            label: (newCtx) => `${newCtx.dataset.label}: ${newCtx.formattedValue}%`
          }
        }
      },
      scales: {
        x: {
          grid: { display: false },
          ticks: { color: '#94A3B8' } // slate-400
        },
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(148, 163, 184, 0.25)', // subtle grid
            drawTicks: false
          },
          ticks: {
            color: '#94A3B8',
            callback: (v) => v + '%'
          }
        }
      },
      layout: { padding: { top: 4, right: 8, bottom: 0, left: 8 } },
      interaction: { intersect: false, mode: 'index' }
    }
  });

  // Download handler (wire to your endpoint later)
  document.querySelector('button:has(svg)').addEventListener('click', () => {
    // Example CSV building from the dummy arrays
    const rows = [['date','this_period_pct','prev_period_pct']];
    lineLabels.forEach((label, i) => rows.push([label, primary[i], compare[i]]));
    const csv = rows.map(r => r.join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'utilization_last_14_days.csv';
    a.click();
    URL.revokeObjectURL(url);
  });
</script>

<script>

let apptLoading = false;

async function fetchAppointments() {
  if (apptLoading) return;            // prevent overlap
  apptLoading = true;

  const tbody = document.getElementById('appt-tbody');

  // Phase 1: show skeleton only
  tbody.innerHTML = `
    <tr id="appt-skeleton">
      <td colspan="11" class="px-6 py-8">
        <div class="space-y-3">
          <div class="shimmer h-5 rounded w-5/6"></div>
          <div class="shimmer h-5 rounded w-5/6"></div>
          <div class="shimmer h-5 rounded w-5/6"></div>
          <div class="shimmer h-5 rounded w-5/6"></div>
        </div>
      </td>
    </tr>
  `;

  const start = performance.now();
  const minMs = 1200; // keep shimmer for at least 1.2s

  const renderEmpty = (msg = 'No appointments found.') => {
    tbody.innerHTML = `
      <tr>
        <td colspan="11" class="py-16">
          <div class="flex items-center justify-center text-gray-500">
            <svg class="w-5 h-5 mr-2 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2a4 4 0 118 0v2" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 7a4 4 0 100-8 4 4 0 000 8z" />
            </svg>
            <span class="text-base">${msg}</span>
          </div>
        </td>
      </tr>
    `;
  };

  try {
    const res = await fetch('/staff_dashboard_data', { headers: { 'Accept': 'application/json' } });
    const elapsed = performance.now() - start;
    if (elapsed < minMs) await new Promise(r => setTimeout(r, minMs - elapsed));

    if (!res.ok) {
      renderEmpty('Unable to load appointments.');
      apptLoading = false;
      return;
    }

    const data = await res.json();

    if (!Array.isArray(data) || data.length === 0) {
      renderEmpty();
      apptLoading = false;
      return;
    }

    // Phase 2: replace skeleton with fresh rows
    const frag = document.createDocumentFragment();
    data.forEach(appt => {
      const tr = document.createElement('tr');
      tr.className = 'bg-white dark:bg-gray-800 border-b dark:border-gray-700 border-gray-200';
      tr.innerHTML = `
        <td class="px-6 py-4 font-medium text-gray-900 dark:text-white whitespace-nowrap">#${String(appt.id ?? '').padStart(4, '0')}</td>
        <td class="px-6 py-4 text-gray-900 dark:text-white whitespace-nowrap">${appt.client_name ?? ''}</td>
        <td class="px-6 py-4 font-light text-gray-500 dark:text-gray-400">${appt.contact_info ?? ''}</td>
        <td class="px-6 py-4 font-light text-gray-500 dark:text-gray-400">${appt.client_gender ?? ''}</td>
        <td class="px-6 py-4 font-light text-gray-500 dark:text-gray-400">${appt.staff_name ?? ''}</td>
        <td class="px-6 py-4 font-light text-gray-500 dark:text-gray-400">${appt.staff_gender ?? ''}</td>
        <td class="px-6 py-4 font-light text-gray-500 dark:text-gray-400">${appt.appointment_time ? new Date(appt.appointment_time).toLocaleString() : ''}</td>
        <td class="px-6 py-4 font-light text-gray-500 dark:text-gray-400">${appt.end_time ? new Date(appt.end_time).toLocaleString() : ''}</td>
        <td class="px-6 py-4 font-light text-gray-500 dark:text-gray-400">${appt.status ?? ''}</td>
        <td class="px-6 py-4 font-light text-gray-500 dark:text-gray-400">£${Number(appt.payment ?? 0).toFixed(2)}</td>
        <td class="px-6 py-4 font-light text-gray-500 dark:text-gray-400">${appt.notes ?? ''}</td>
      `;
      frag.appendChild(tr);
    });

    tbody.innerHTML = '';       // remove skeleton
    tbody.appendChild(frag);    // insert new rows
  } catch (e) {
    const elapsed = performance.now() - start;
    if (elapsed < minMs) await new Promise(r => setTimeout(r, minMs - elapsed));
    console.error(e);
    renderEmpty('Something went wrong. Please try again.');
  } finally {
    apptLoading = false;
  }
}

// init + poll (safe)
document.addEventListener('DOMContentLoaded', fetchAppointments);
const apptPoll = setInterval(fetchAppointments, 100000);

  </script>
  
  
</body>

</html>